# Research: V2 Locale Handling for V3 Release Planning

**Jira**: https://concord-consortium.atlassian.net/browse/CODAP-1093
**Repo**: git@github.com:concord-consortium/codap.git
**Implementation Spec**: [implementation.md](implementation.md)
**Status**: **In Development**

## Overview

Research how V2 CODAP handles locale/language deployment and auto-detection so that V3 can properly redirect legacy V2 language-specific URLs and handle the transition from V2's per-language builds to V3's unified single-build internationalization system.

## Project Owner Overview

CODAP V2 (SproutCore-based) deploys a separate build artifact for each of its 15 supported languages, with URLs like `/static/dg/es/cert/index.html`. V3 (React-based) ships a single build that supports all languages and allows switching without a page reload. As the team plans the V3 rollout to replace V2, it is critical to understand V2's locale architecture — including its auto-detection behavior, per-language URL structure, and deployment paths — so that existing users, bookmarks, and external links to V2 language builds are gracefully redirected to V3 with the correct language parameter. This research also identifies any other locale-related concerns that could affect the release.

## Background

### V2 Locale Architecture

V2 uses SproutCore's `.lproj` directory convention for translations. The master English strings live in `lang/strings/en-US.json`, and the build process (via `bin/makeCodapZip`) produces a separate complete build per language under `dist/build_XXXX/static/dg/{lang}/cert/`. Each language directory contains its own `index.html`, packed JavaScript, and stylesheet.

**Supported V2 languages** (13): `de`, `el`, `en`, `es`, `he`, `ja`, `nb`, `nn`, `pt-BR`, `th`, `tr`, `zh-Hans`, `zh-TW`.

### V2 Auto-Detection

V2's root `index.html` (generated by `bin/makeCodapZip`, lines 83–121) contains a redirect script that:

1. Reads `navigator.language` from the browser
2. Maps `zh-CN` → `zh-Hans`
3. Extracts the base language code (e.g., `en` from `en-US`)
4. Matches against supported languages
5. Falls back to `en` if no match
6. Redirects to `./static/dg/{lang}/cert/index.html`, preserving query string and hash

### V2 Language Switching

V2 allows switching via a language menu in the CFM (Cloud File Manager) bar. The function `makeNewLocaleUrl()` in `apps/dg/main.js` rewrites the URL path to swap the language directory segment. This requires a full page load of the new language build.

V2 also supports a `lang-override` URL parameter (`apps/dg/core.js`, lines 501–510) which takes precedence over the build's compiled language.

### V2 URL Structure

Production URLs follow this pattern:
```
https://codap.concord.org/releases/latest/static/dg/{LANG}/cert/index.html
```

The root URL (`/releases/latest/`) serves the auto-detecting redirect page.

### V2 Translation Pipeline

Translations are managed via POEditor (project ID: 125447). Scripts in `bin/` handle pushing English source strings and pulling translated strings, converting them to SproutCore's `SC.stringsFor()` format in `.lproj/strings.js` files.

### V3 Locale Architecture

V3 uses a custom MobX-powered i18n system (no external library). All translation files are JSON/JSON5 in `v3/src/utilities/translation/lang/`. The `gLocale` MobX observable in `v3/src/utilities/translation/locale.ts` drives reactivity — changing the language triggers automatic re-renders across all observer-wrapped components without a page reload.

**V3 language detection priority** (`locale.ts`, lines 5–17):
1. URL parameter `?lang=` or `?lang-override=`
2. Browser's `navigator.languages` array
3. Fallback to `en-US`

V3 supports 15 languages — the same 13 as V2 plus `fa` (Farsi) and `ko` (Korean).

### V3 URL Parameter

V3 accepts `?lang={code}` or `?lang-override={code}` to force a specific language (defined in `v3/src/utilities/url-params.ts`, lines 137–146).

## Requirements

- **R1**: Document the complete list of V2 per-language deployment URLs that may exist as bookmarks, links in curricula, or embedded iframes. *(Detailed URL analysis via Athena queries in [PR #2339](https://github.com/concord-consortium/codap/pull/2339))*
- **R2**: Determine whether V2 auto-detection behavior matches V3 auto-detection behavior, and identify any differences that could surprise users during the transition.
- **R3**: Identify a redirect strategy for V2 language-specific URLs to V3 with the appropriate `?lang=` parameter.
- **R4**: Document any locale codes that differ between V2 and V3 (e.g., `en` vs `en-US`).
- **R5**: Identify any other locale-related concerns that could affect V3 rollout (e.g., RTL support, font loading, date/number formatting differences).

## Technical Notes

### Key V2 Files
| File | Purpose |
|------|---------|
| `lang/strings/en-US.json` | Master translation source |
| `apps/dg/{xx}.lproj/strings.js` | SproutCore string bundles |
| `apps/dg/core.js` (lines 501–591) | Language config & locale list |
| `apps/dg/main.js` | Language menu & switching logic |
| `bin/makeCodapZip` (lines 75–121) | Builds all languages & auto-detect redirect |
| `bin/strings-pull-project.sh` | Pulls translations from POEditor |
| `Buildfile` (lines 14–32) | SproutCore build configuration |

### Key V3 Files
| File | Purpose |
|------|---------|
| `v3/src/utilities/translation/locale.ts` | MobX locale state & auto-detection |
| `v3/src/utilities/translation/translate.ts` | Translation function |
| `v3/src/utilities/translation/languages.ts` | Language imports & definitions |
| `v3/src/utilities/translation/lang/` | Translation JSON files |
| `v3/src/utilities/url-params.ts` (lines 137–146) | `lang` / `lang-override` URL params |
| `v3/src/lib/cfm/use-cloud-file-manager.ts` (lines 239–258) | Language menu in CFM |

### Locale Code Differences
| Language | V2 Code | V3 Code | Notes |
|----------|---------|---------|-------|
| English | `en` | `en-US` | V2 uses digraph, V3 uses full locale |

All other languages appear to use the same codes in both versions.

### Auto-Detection Comparison
| Aspect | V2 | V3 |
|--------|----|----|
| API used | `navigator.language` (single) | `navigator.languages` (array) |
| URL param | `lang-override` | `lang` or `lang-override` |
| Fallback | `en` | `en-US` |
| `zh-CN` handling | Maps to `zh-Hans` | Matches via base language lookup |
| Detection timing | Server redirect (root index.html) | Client-side at app initialization |

## Out of Scope

- Changes to V3's i18n implementation itself (this is research only).
- Adding new languages to either V2 or V3.
- Modifying V2's build or deployment process.

## Open Questions

### RESOLVED: What are the exact production URLs that need redirection?
**Context**: V2 is deployed at multiple paths (releases/latest, releases/build_XXXX, possibly versioned paths). We need to know all URL patterns that external content links to.
**Options considered**:
- A) Only `codap.concord.org/releases/latest/static/dg/{lang}/cert/index.html`
- B) Multiple release paths including versioned builds
- C) Additional domains or subdomains

**Decision**: Analysis performed via CODAP logs with Athena queries. Details in [PR #2339](https://github.com/concord-consortium/codap/pull/2339).

### RESOLVED: How should V2 language URLs redirect to V3?
**Context**: When V3 replaces V2, users hitting V2 language-specific URLs need to land on V3 with the right language. This could be handled via server-side redirects, a new redirect page, or by modifying the existing auto-detect page.
**Options considered**:
- A) Server-side (CloudFront/S3) redirect rules mapping `/static/dg/{lang}/cert/` to V3 URL with `?lang={lang}`
- B) Replace V2's root `index.html` auto-detect page with one that redirects to V3
- C) Both: server-side redirects for deep links, plus updated auto-detect page for root URL

**Decision**: Option C with a nuance. The concern about `?lang=en` overriding browser preferences is valid.

**Research finding**: V3's language detection (`locale.ts:5-6`) prioritizes URL parameters over browser settings:
```javascript
const urlLanguage = urlParams.lang || urlParams["lang-override"] || ""
const candidates = [urlLanguage, ...window.navigator.languages]
```

**Recommended redirect strategy**:
| Source URL | Redirect to | Rationale |
|------------|-------------|-----------|
| V2 root (auto-detect page) | V3 root (no `?lang=`) | Let V3 auto-detect from browser |
| `/app` or other English defaults | V3 root (no `?lang=`) | Don't force English; respect browser preference |
| `/static/dg/en/cert/` | V3 root (no `?lang=`) | English may be default, not explicit choice; let V3 auto-detect |
| `/static/dg/{non-en-lang}/cert/` | V3 with `?lang={lang}` | Non-English is almost always an explicit choice |

This approach prioritizes respecting current browser preferences. Non-English bookmarks are preserved because they represent deliberate language choices. English bookmarks defer to auto-detection since English is often just the default users landed on, not an explicit preference.

**Edge case**: A user with a non-English browser who deliberately chose English in V2 would now get their browser language in V3. They can easily switch via the language menu (V3's switch is instant, no reload).

**Critical — URL parameter preservation**:
- **Query strings** (`?url=...`, `?launchFromLara=...`): Can be preserved by server-side HTTP redirects (CloudFront/S3 rules).
- **Hash fragments** (`#shared=...`): **Cannot** be preserved by server-side redirects — browsers don't send the `#` portion to the server. Preserving hashes requires **client-side redirect pages** (HTML+JS that reads `window.location.hash` and constructs the full destination URL).

V2's auto-detect root page already uses client-side JS for this reason. For language-specific paths (`/static/dg/{lang}/cert/`), if hash preservation is required, the redirect must be implemented as an HTML page with JavaScript, not a pure HTTP 301/302 rule.

**Redirect type**: Use 302 (temporary) redirects initially. This allows the strategy to be adjusted if issues arise. Once the transition is validated and stable, switch to 301 (permanent) for better SEO and browser caching.

### RESOLVED: Are there embedded iframes or external curricula linking directly to V2 language URLs?
**Context**: If curriculum materials or other sites embed CODAP via iframes using language-specific V2 URLs, those need to keep working after the transition. The scope of this concern affects how robust the redirect strategy needs to be.
**Options considered**:
- A) Yes, there are known embedded uses that need to be preserved
- B) No, CODAP is generally accessed directly, not embedded with language-specific URLs
- C) Unknown — needs investigation

**Decision**: A — Yes, there are many embedded uses that need to be preserved. This reinforces the need for robust server-side redirects that work for iframe embeds (not just browser navigations).

### RESOLVED: Should V3 preserve V2's `lang-override` URL parameter in addition to `lang`?
**Context**: V3 already supports both `lang` and `lang-override`. V2 only uses `lang-override`. If external content uses `?lang-override=`, this already works in V3. Confirming no action is needed here.
**Options considered**:
- A) Already handled — V3 supports both, no action needed
- B) Deprecate `lang-override` in V3 and only use `lang`

**Decision**: A — No action needed. V3 already supports both parameters (`url-params.ts:140,146`).

### RESOLVED: Are there RTL (right-to-left) layout concerns for Hebrew and Farsi in V3?
**Context**: Hebrew (`he`) and Farsi (`fa`) are RTL languages. V2 may or may not have had full RTL support. If V3's RTL support differs from V2, this could affect users of those languages during the transition.
**Options considered**:
- A) V3 has full RTL support, no concern
- B) V3 has partial RTL support, may need work before release
- C) Neither V2 nor V3 has RTL support — consistent behavior, no concern for transition

**Decision**: C — Neither V2 nor V3 has proper RTL layout support.

**Research findings**:
- **V3**: The `<html>` tag has no `dir` attribute, and `locale.ts` does not set `document.documentElement.dir = "rtl"` when Hebrew or Farsi is selected. V3 does load appropriate fonts (`Noto Sans Hebrew`, `Noto Sans Arabic` in `index.html:11`), so RTL text *renders* correctly, but the overall UI layout remains LTR.
- **V2**: Similarly has no RTL layout switching. The only `direction: rtl` CSS in both codebases is a text-truncation trick (showing the end of long attribute names via `bidi-override`), not actual RTL support.
- **Conclusion**: Users of Hebrew and Farsi will have the same experience in V3 as they did in V2 — translated strings in a LTR layout. No transition concern, though full RTL support could be a future enhancement.

## Self-Review

### Senior Engineer

#### RESOLVED: Does V3 handle the `en` locale code (without region)?
The spec notes that V2 uses `en` while V3 uses `en-US`. The redirect strategy avoids this by not passing `?lang=en`. But what if external content or users manually use `?lang=en`? Does V3's `languages.ts` handle `en` → `en-US` mapping, or would it fail to find a match and fall back?

**Resolution**: No action needed. V3's `languages.ts:49-56` registers both full locale codes (e.g., `en-US`) and base language codes (e.g., `en`) pointing to the same translations. `?lang=en` works correctly.

---

#### RESOLVED: Query string and hash preservation in redirects
V2's auto-detect page explicitly preserves query strings and hashes when redirecting. The recommended redirect strategy should specify that server-side redirects must also preserve `?param=value` and `#hash` fragments. This is critical for document URLs like `?url=...` or plugin parameters.

**Resolution**: Added explicit requirement to the redirect strategy section. Clarified (per external review) that query strings can be preserved by server-side redirects, but hash fragments require client-side redirect pages since browsers don't send `#` to the server.

---

### QA Engineer

#### RESOLVED: Missing acceptance criteria for redirect testing
The spec recommends a redirect strategy but doesn't define how to verify it works. Suggest adding:
- Test matrix of source URLs → expected destination URLs
- Verification that embedded iframes redirect correctly (not blocked by X-Frame-Options)
- Method to test query string/hash preservation

**Resolution**: Deferred to implementation. When the redirect implementation story is created, it should include detailed test criteria covering the redirect matrix, iframe behavior, and query string/hash preservation.

---

#### RESOLVED: Rollback plan not documented
If the redirects cause unexpected issues (broken embeds, user confusion), what's the rollback strategy? Can V2 be quickly restored while issues are investigated?

**Resolution**: Deferred to implementation. The rollback approach depends on how redirects are implemented (CloudFront rules, S3 objects, etc.). The implementation story should include a documented rollback procedure.

---

### Product Manager

#### RESOLVED: Success metrics not defined
How will the team know the transition succeeded? Consider:
- Monitor 404 rates for V2 paths post-transition
- Track language distribution in V3 analytics vs. V2 baseline
- User support tickets related to language issues

**Resolution**: Deferred to implementation. The implementation story should define success metrics and monitoring approach.

---

### DevOps Engineer

#### RESOLVED: Redirect type not specified (301 vs 302)
Should redirects be 301 (permanent) or 302 (temporary)?
- 301: Better for SEO, browsers cache aggressively
- 302: Easier to change if strategy needs adjustment
Recommendation: Use 302 initially, switch to 301 after transition is validated.

**Resolution**: Added recommendation to redirect strategy section: use 302 initially, switch to 301 after validation.

---

#### RESOLVED: Monitoring and alerting for redirect failures
How will the team detect if redirects are failing or causing issues? Suggest CloudWatch alarms on 4xx/5xx rates for V2 paths.

**Resolution**: Deferred to implementation. The implementation story should include monitoring setup for redirect failures.

---

### Teacher

#### RESOLVED: Classroom consistency concern with English redirect strategy
The current strategy redirects `/static/dg/en/cert/` without `?lang=`, letting V3 auto-detect. However, curriculum materials may intentionally link to English CODAP to ensure all students in a classroom see the same language regardless of their browser settings.

After the transition, a teacher's English CODAP link would show different languages to different students based on their browsers. This could cause confusion in a classroom setting where consistency matters.

**Options**:
- A) Accept this behavior change — students seeing their preferred language is arguably better
- B) Provide guidance to curriculum authors to use `?lang=en` explicitly if they need English
- C) Reconsider the English redirect strategy

**Resolution**: A + B. Accept the behavior change (students seeing their preferred language is an improvement for individual learners). For curriculum authors who need classroom consistency, provide guidance in release notes/documentation to use `?lang=en` explicitly when English is required regardless of browser settings.
